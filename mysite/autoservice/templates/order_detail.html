{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block heading %}{% trans "Order Detail" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h2>{% trans "Order" %} #{{ order.id }}</h2>
    {% if user == order.user %}
    <div>
        <a href="{% url 'autoservice:order-update' order.pk %}" class="btn btn-warning btn-sm">
            <i class="fas fa-edit"></i> {% trans "Edit" %}
        </a>
        <a href="{% url 'autoservice:order-delete' order.pk %}" class="btn btn-danger btn-sm">
            <i class="fas fa-trash"></i> {% trans "Delete" %}
        </a>
    </div>
    {% endif %}
</div>

<p><b>{% trans "Date:" %}</b> {{ order.date }}</p>
<p><b>{% trans "Car:" %}</b> {{ order.car }}</p>
<p><b>{% trans "Status:" %}</b> {{ order.get_status_display }}</p>
{% if order.due_back %}
<p><b>{% trans "Due:" %}</b> {{ order.due_back }}
    {% if order.is_overdue %}<span class="badge badge-danger">{% trans "Overdue!" %}</span>{% endif %}
</p>
{% endif %}

<hr>

<div class="d-flex justify-content-between align-items-center">
    <h4>{% trans "Order Lines" %}</h4>
    {% if user == order.user %}
    <a href="{% url 'autoservice:orderline-create' order.pk %}" class="btn btn-success btn-sm">
        <i class="fas fa-plus"></i> {% trans "Add Service" %}
    </a>
    {% endif %}
</div>
<table class="table">
  <thead>
    <tr>
      <th>{% trans "Service" %}</th>
      <th>{% trans "Quantity" %}</th>
      <th>{% trans "Price" %}</th>
      <th>{% trans "Sum" %}</th>
      {% if user == order.user %}<th>{% trans "Actions" %}</th>{% endif %}
    </tr>
  </thead>
  <tbody>
    {% for line in lines %}
      <tr>
        <td>{{ line.service }}</td>
        <td>{{ line.quantity }}</td>
        <td>{% if line.service %}{{ line.service.price|floatformat:2 }} €{% else %}-{% endif %}</td>
        <td>{{ line.line_sum|floatformat:2 }} €</td>
        {% if user == order.user %}
        <td>
            <a href="{% url 'autoservice:orderline-update' line.pk %}" class="btn btn-warning btn-sm" title="{% trans "Edit" %}">
                <i class="fas fa-edit"></i>
            </a>
            <a href="{% url 'autoservice:orderline-delete' line.pk %}" class="btn btn-danger btn-sm" title="{% trans "Delete" %}">
                <i class="fas fa-trash"></i>
            </a>
        </td>
        {% endif %}
      </tr>
    {% empty %}
      <tr><td colspan="{% if user == order.user %}5{% else %}4{% endif %}">{% trans "No order lines" %}</td></tr>
    {% endfor %}
  </tbody>
</table>

<h4 class="text-right mt-3">
    {% trans "Total:" %} {{ order.total|floatformat:2 }} €
</h4>

<hr>

<h4>{% trans "Reviews" %}</h4>
{% for review in reviews %}
<div class="card mb-2">
    <div class="card-body d-flex">
        <div class="mr-3">
            {% if review.reviewer.photo %}
                <img src="{{ review.reviewer.photo.url }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
            {% else %}
                <img src="{% static 'img/undraw_profile.svg' %}" class="rounded-circle" style="width: 50px; height: 50px;">
            {% endif %}
        </div>
        <div>
            <p class="card-text mb-1">{{ review.content }}</p>
            <small class="text-muted">
                <strong>{{ review.reviewer }}</strong> | {{ review.date_created }}
            </small>
        </div>
    </div>
</div>
{% empty %}
<p class="text-muted">{% trans "No reviews yet." %}</p>
{% endfor %}

{% if user.is_authenticated %}
<h5 class="mt-4">{% trans "Leave a Review" %}</h5>
<form method="post" class="mb-3">
    {% csrf_token %}
    {% load crispy_forms_tags %}
    {{ form | crispy }}
    <button type="submit" class="btn btn-primary">{% trans "Submit" %}</button>
</form>
{% else %}
<p class="text-muted mt-3"><a href="{% url 'login' %}">{% trans "Log in" %}</a> {% trans "to leave a review." %}</p>
{% endif %}

<a href="{% url 'autoservice:order-list' %}">← {% trans "Back to orders" %}</a>
{% endblock %}
